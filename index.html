<html>
	<head>
		<meta charset="utf-8">
		<meta name="viewport" content="width=device-width,initial-scale=1.0,minimum-scale=1.0,maximum-scale=1.0,user-scalable=no">
		<title>武汉疫情可视化</title>
		<script src="https://cdn.jsdelivr.net/npm/vue/dist/vue.js"></script>
		<!-- 引入 echarts.js -->
		<script src="js/echarts.min.js"></script>
		<script src="js/jquery.min.js"></script>
		<script src="js/china.js"></script>
		<link rel="icon" href="assets/favicon.ico">
		<link rel="stylesheet" type="text/css" href="assets/style.css">
	</head>
	<body style="margin: 0px;">
		<div id="app" style="width: 100%;height:100%;">
			<div class="changedata change_1" id="bl" v-on:click="bl">确诊病例</div>
			<div class="changedata change_2" id="zs" v-on:click="zs">致死率</div>
			<div class="changedata change_3" id="zy" v-on:click="zy">治愈率</div>
			<div class="changedata change_4" id="cw" v-on:click="cw">确诊/万武汉迁入</div>
			<div class="changedata change_5" id="yy" v-on:click="yy">医院数量</div>
			<div class="changedata live"><img src="assets/live.png" style="height: 12px;width: 12px;">&nbsp;&nbsp;Live / 10分钟</div>
			<div class="changedata git_link" onclick="window.open('https://github.com/guanyilun/wuhan_viz')"><img src="assets/git.png"
				 style="height: 18px;width: 18px;">&nbsp;Github</div>
			<!-- 为ECharts准备一个具备大小（宽高）的Dom -->
			<div id="main" style="width: 100%;height:100%;">
			</div>
		</div>
		<script type="text/javascript">
			window.onload = function() {
				document.addEventListener('touchstart', function(event) {
					if (event.touches.length > 1) {
						event.preventDefault()
					}
				})
				document.addEventListener('gesturestart', function(event) {
					event.preventDefault()
				})
			}

			var vm = new Vue({
				el: '#app',
				data: {
					selected: "",
					option: {
						backgroundColor: '#404a59',
						title: {
							text: '',
							left: 'center',
							textStyle: {
								color: '#fff'
							}
						},
						tooltip: {
							trigger: 'item',
							formatter: function(params, ticket, callback) {
								if (params.seriesType == "effectScatter") {
									return params.data.name + ": " + params.data.value[2];
								} else if (params.seriesType == "lines") {
									return params.data.fromName + " -> " + params.data.toName + ": " + params.data.value;
								} else {
									return params.name;
								}
							}
						},
						legend: {
							show: false,
							orient: 'vertical',
							top: 'bottom',
							left: 'right',
							data: ['地点', '线路'],
							textStyle: {
								color: '#fff'
							}
						},
						geo: {
							map: 'china',
							zoom: 1.2,
							label: {
								emphasis: {
									show: false
								}
							},
							roam: true,
							itemStyle: {
								normal: {
									areaColor: '#323c48',
									borderColor: '#404a59'
								},
								emphasis: {
									areaColor: '#2a333d'
								}
							}
						},
						series: [{
							name: '地点',
							type: 'effectScatter',
							coordinateSystem: 'geo',
							zlevel: 2,
							rippleEffect: {
								brushType: 'stroke'
							},
							label: {
								normal: {
									show: true,
									position: 'right',
									formatter: '{b}'
								},
							},
							symbolSize: 2,
							showEffectOn: 'render',
							itemStyle: {
								normal: {
									color: '#46bee9',
									opacity: 0.7
								}
							},
							data: []
						}, {
							name: '线路',
							type: 'lines',
							coordinateSystem: 'geo',
							zlevel: 2,
							large: true,
							effect: {
								show: true,
								constantSpeed: 30,
								symbol: 'pin',
								symbolSize: 3,
								trailLength: 0,
							},
							lineStyle: {
								normal: {
									color: new echarts.graphic.LinearGradient(0, 0, 0, 1, [{
										offset: 0,
										color: '#58B3CC'
									}, {
										offset: 1,
										color: '#F58158'
									}], false),
									width: 1,
									opacity: 0.2,
									curveness: 0.1
								}
							},
							data: []
						}],
					}
				},
				methods: {
					bl() {
						var that = this;
						var myChart = echarts.init(document.getElementById('main'));
						$.get('data/cases_echart.json', (json) => {
							that.option.series[0].data = json;
							that.option.title.text = "确诊病例";
							if (that.selected != "") {
								that.selected.style.backgroundColor = "black";
							}
							that.selected = document.getElementById('bl')
							that.selected.style.backgroundColor = "grey";
							var opt = myChart.getOption();
							that.show_part(myChart, opt);
						})
					},
					zs() {
						var that = this;
						var myChart = echarts.init(document.getElementById('main'));
						$.get('data/fatality_echart.json', (json) => {
							that.option.series[0].data = json;
							that.option.title.text = "致死率";
							if (that.selected != "") {
								that.selected.style.backgroundColor = "black";
							}
							that.selected = document.getElementById('zs')
							that.selected.style.backgroundColor = "grey";
							var opt = myChart.getOption();
							that.show_part(myChart, opt);
						})
					},
					zy() {
						var that = this;
						var myChart = echarts.init(document.getElementById('main'));
						$.get('data/cure_echart.json', (json) => {
							that.option.series[0].data = json;
							that.option.title.text = "治愈率";
							if (that.selected != "") {
								that.selected.style.backgroundColor = "black";
							}
							that.selected = document.getElementById('zy')
							that.selected.style.backgroundColor = "grey";
							var opt = myChart.getOption();
							that.show_part(myChart, opt);
						})
					},
					cw() {
						var that = this;
						var myChart = echarts.init(document.getElementById('main'));
						$.get('data/confirm_per_10000_echart.json', (json) => {
							that.option.series[0].data = json;
							that.option.title.text = "确诊/万武汉迁入";
							if (that.selected != "") {
								that.selected.style.backgroundColor = "black";
							}
							that.selected = document.getElementById('cw')
							that.selected.style.backgroundColor = "grey";
							var opt = myChart.getOption();
							that.show_part(myChart, opt);
						})
					},
					yy() {
						var that = this;
						var myChart = echarts.init(document.getElementById('main'));
						$.get('data/hospital_echart.json', (json) => {
							that.option.series[0].data = json;
							that.option.title.text = "医院数量";
							if (that.selected != "") {
								that.selected.style.backgroundColor = "black";
							}
							that.selected = document.getElementById('yy')
							that.selected.style.backgroundColor = "grey";
							var opt = myChart.getOption();
							that.show_part(myChart, opt);
						})
					},
					show_part(myChart, opt) {
						var show = Math.floor(Math.exp(opt.geo[0].zoom)-1)
						if (show < this.option.series[0].data.length) {
							var top10 = this.option.series[0].data.sort(function(a, b) {
								return b.value[2] - a.value[2];
							}).slice(0, show);
							opt.series[0].data = top10;
							// console.log("opt0:",opt)
							opt.title[0].text = this.option.title.text;
							// console.log("opt1:",opt)
							myChart.setOption(opt);
						} else {
							// console.log(that.option)
							this.option.geo.zoom = opt.geo[0].zoom;
							myChart.setOption(this.option);
						}
					}
				},
				// watch: {
				// 	'myChart.getOption().geo[0].zoom': function(val) {
				// 		console.log(val)
				// 	},
				// 	// {
				// 	// 	if (option.geo.zoom < 3) {
				// 	// 		option.series[0].data = option.series[0].data.sort(function(a, b) {
				// 	// 			return b.value[2] - a.value[2];
				// 	// 		}).slice(0, 9)
				// 	// 	}
				// 	// },
				// 	imediatte: true
				// },
				mounted() {
					// 基于准备好的dom，初始化echarts实例
					var myChart = echarts.init(document.getElementById('main'));
					myChart.setOption(this.option);
					var that = this;
					$.get('data/cases_echart.json', (json) => {
						that.option.series[0].data = json;
						that.option.title.text = "确诊病例";
						if (that.selected != "") {
							that.selected.style.backgroundColor = "black";
						}
						that.selected = document.getElementById('bl')
						that.selected.style.backgroundColor = "grey";
						var opt = myChart.getOption();
						that.show_part(myChart, opt)
					});
					$.get('data/moves_echart.json', (json) => {
						that.option.series[1].data = json;
						// console.log(myChart.getOption())
					});
					myChart.on('georoam', function(params) {
						var opt = myChart.getOption();
						// console.log(opt.geo[0].zoom);
						that.show_part(myChart, opt)
					})
					// // 使用刚指定的配置项和数据显示图表。
				}
			})
		</script>
		<script type="text/javascript" src="http://tajs.qq.com/stats?sId=66514846" charset="UTF-8"></script>
	</body>
</html>
